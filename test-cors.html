<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashScope CORS æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        h1 { color: #00d9ff; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        label { display: block; margin-bottom: 8px; color: #aaa; }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        #result {
            margin-top: 30px;
            padding: 20px;
            background: #0f0f23;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left-color: #00d26a !important; }
        .error { border-left-color: #ff6b6b !important; }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .status.testing { background: #f0ad4e; color: #000; }
        .status.cors-ok { background: #00d26a; color: #000; }
        .status.cors-fail { background: #ff6b6b; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ DashScope CORS æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•æµè§ˆå™¨èƒ½å¦ç›´æ¥è°ƒç”¨ DashScope APIï¼ˆæ— éœ€åç«¯ä»£ç†ï¼‰</p>
        
        <label for="apiKey">DashScope API Key:</label>
        <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxx">
        
        <button id="testBtn" onclick="testCORS()">å¼€å§‹æµ‹è¯•</button>
        
        <div id="result" style="display: none;"></div>
    </div>

    <script>
        async function testCORS() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.className = '';
            resultDiv.innerHTML = '<span class="status testing">â³ æµ‹è¯•ä¸­...</span>\næ­£åœ¨ä»æµè§ˆå™¨ç›´æ¥è°ƒç”¨ DashScope API...';
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            
            // ç®€å•çš„æµ‹è¯•è¯·æ±‚ - ä½¿ç”¨ä¸€ä¸ªå°çš„æµ‹è¯• prompt
            const testPayload = {
                model: 'qwen-vl-max',  // ä½¿ç”¨è¾ƒè½»é‡çš„æ¨¡å‹æµ‹è¯•
                input: {
                    messages: [
                        {
                            role: 'user',
                            content: [
                                { text: 'Hello, this is a CORS test. Please respond with "OK".' }
                            ]
                        }
                    ]
                }
            };
            
            try {
                console.log('å¼€å§‹ CORS æµ‹è¯•...');
                
                const response = await fetch(
                    'https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(testPayload)
                    }
                );
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `<span class="status cors-ok">âœ… CORS æ”¯æŒ!</span>

ğŸ‰ å¥½æ¶ˆæ¯ï¼DashScope API æ”¯æŒæµè§ˆå™¨ç›´æ¥è°ƒç”¨ï¼

è¿™æ„å‘³ç€ï¼š
â€¢ æ— éœ€ Netlify Functions æˆ–å…¶ä»–åç«¯ä»£ç†
â€¢ å¯ä»¥ç›´æ¥éƒ¨ç½²åˆ° GitHub Pages
â€¢ å‰ç«¯ç›´æ¥è°ƒç”¨ APIï¼Œç”¨æˆ·è¾“å…¥è‡ªå·±çš„ API Key

API å“åº”:
${JSON.stringify(data, null, 2)}`;
                } else {
                    // API è¿”å›äº†é”™è¯¯ï¼Œä½†è¯·æ±‚æˆåŠŸåˆ°è¾¾ï¼ˆè¯´æ˜ CORS OKï¼‰
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `<span class="status cors-ok">âœ… CORS æ”¯æŒ!</span>

è™½ç„¶ API è¿”å›äº†é”™è¯¯ï¼ˆå¯èƒ½æ˜¯æ¨¡å‹/å‚æ•°é—®é¢˜ï¼‰ï¼Œä½†è¯·æ±‚æˆåŠŸåˆ°è¾¾æœåŠ¡å™¨ï¼
è¿™è¯´æ˜ CORS æ˜¯æ”¯æŒçš„ï¼Œå¯ä»¥ç›´æ¥ä»æµè§ˆå™¨è°ƒç”¨ã€‚

API å“åº”:
${JSON.stringify(data, null, 2)}`;
                }
                
            } catch (error) {
                console.error('CORS æµ‹è¯•å¤±è´¥:', error);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ CORS é”™è¯¯
                if (error.message.includes('CORS') || 
                    error.message.includes('NetworkError') ||
                    error.message.includes('Failed to fetch') ||
                    error.name === 'TypeError') {
                    resultDiv.className = 'error';
                    resultDiv.innerHTML = `<span class="status cors-fail">âŒ CORS ä¸æ”¯æŒ</span>

DashScope API ä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è°ƒç”¨ï¼ˆCORS è¢«é˜»æ­¢ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
1. ä½¿ç”¨ Cloudflare Workers ä½œä¸ºå…è´¹ API ä»£ç†ï¼ˆæ¨èï¼‰
2. ç»§ç»­ä½¿ç”¨ Netlify Functions
3. ä½¿ç”¨å…¶ä»–æ”¯æŒ CORS çš„ API ä»£ç†æœåŠ¡

é”™è¯¯è¯¦æƒ…:
${error.name}: ${error.message}`;
                } else {
                    resultDiv.className = 'error';
                    resultDiv.innerHTML = `<span class="status cors-fail">âŒ è¯·æ±‚å¤±è´¥</span>

é”™è¯¯: ${error.message}

è¯·æ£€æŸ¥:
1. API Key æ˜¯å¦æ­£ç¡®
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`;
                }
            }
            
            testBtn.disabled = false;
            testBtn.textContent = 'é‡æ–°æµ‹è¯•';
        }
    </script>
</body>
</html>
